<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I Miei Itinerari</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-select {
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-danger:hover {
            background: #c53030;
        }

        .btn-edit {
            background: #38a169;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-edit:hover {
            background: #2f855a;
        }

        .itinerari-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 25px;
        }

        .itinerario-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .itinerario-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }

        .card-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            position: relative;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-bozza {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .status-completato {
            background: rgba(72,187,120,0.2);
            color: #48bb78;
        }

        .card-body {
            padding: 20px;
        }

        .descrizione {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .travel-mode {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #f7fafc;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #4a5568;
            margin-bottom: 15px;
        }

        .luoghi-list {
            margin-bottom: 20px;
        }

        .luoghi-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .luoghi-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .luogo-tag {
            background: #e6fffa;
            color: #2c7a7b;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            border: 1px solid #b2f5ea;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.2rem;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: white;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .empty-state p {
            font-size: 1.1rem;
            opacity: 0.8;
            margin-bottom: 25px;
        }

        .date-info {
            font-size: 0.8rem;
            color: #a0aec0;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .itinerari-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>I Miei Itinerari</h1>
            <p>Gestisci e visualizza tutti i tuoi itinerari salvati</p>
        </div>

        <div class="controls">
            <input type="text" class="search-box" id="searchInput" placeholder="Cerca itinerari per titolo o luogo...">
            
            <select class="filter-select" id="statusFilter">
                <option value="">Tutti gli stati</option>
                <option value="bozza">Bozza</option>
                <option value="completato">Completato</option>
            </select>
            
            <select class="filter-select" id="travelModeFilter">
                <option value="">Tutte le modalità</option>
                <option value="DRIVING">In Auto</option>
                <option value="WALKING">A Piedi</option>
                <option value="BICYCLING">In Bicicletta</option>
                <option value="TRANSIT">Trasporti Pubblici</option>
            </select>
            
            <button class="btn btn-primary" onclick="caricaItinerari()">Aggiorna</button>
            <a href="CreaItinerario.html" class="btn btn-secondary">Nuovo Itinerario</a>
        </div>

        <div id="loadingDiv" class="loading" style="display: none;">
            Caricamento itinerari...
        </div>

        <div id="itinerariContainer" class="itinerari-grid">
            <!-- Gli itinerari verranno caricati qui -->
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <h3>Nessun itinerario trovato</h3>
            <p>Non hai ancora creato nessun itinerario o non ci sono risultati per i filtri selezionati</p>
            <a href="CreaItinerario.html" class="btn btn-primary">Crea il tuo primo itinerario</a>
        </div>
    </div>

    <script>
        let itinerari = []; //la variabile resta visibile solo all'interno della funzione in cui è stata dichiarata
        let itinerariOriginali = [];

        // Carica gli itinerari all'avvio della pagina
        document.addEventListener('DOMContentLoaded', function() { //aspetta che l'intero file html venga caricato e parsato prima di caricare gli itinerari
            caricaItinerari(); //esegui questa funzione solo quando il DOM è caricato
            
            // Event listeners per filtri con debounce per la ricerca
            document.getElementById('searchInput').addEventListener('input', applicaFiltriConDebounce);//associo l'evento input a searchInput 
            document.getElementById('statusFilter').addEventListener('change', applicaFiltri);
            document.getElementById('travelModeFilter').addEventListener('change', applicaFiltri);
        });

        // Funzione per caricare tutti gli itinerari dal backend
        async function caricaItinerari() {
            //prende i div HTML dove mostreremo:
            const loadingDiv = document.getElementById('loadingDiv'); //messaggio di caricamento
            const container = document.getElementById('itinerariContainer'); //lista degli itinerari
            const emptyState = document.getElementById('emptyState'); //messaggio quando non ci sono gli itinerari

            try {
                loadingDiv.style.display = 'block'; //mostra il caricamento (loadingDIV)
                container.innerHTML = ''; //pulisce il container
                emptyState.style.display = 'none'; //nasconde il messaggio "vuoto"

                const response = await fetch('/api/itinerari/visualizza'); //chiamata fetch
                
                if (!response.ok) { //se lo status HTTP non è ok
                    throw new Error(`Errore HTTP: ${response.status}`); //lancia un errore, catturato poi dal catch
                }

                const result = await response.json(); //continene i dati degli itinerari dal server
                console.log('Itinerari caricati:', result);
                
                //Entrambi da capire meglio
                itinerariOriginali = result.data || result || []; //mantiene la lista completa dal DB
                itinerari = [...itinerariOriginali]; //Lista filtrabile e manipolabile nella pagina senza toccare l'originale

                loadingDiv.style.display = 'none'; //nasconde il caricamento

                if (itinerari.length === 0) {
                    emptyState.style.display = 'block'; //se non ci sono itinerari mostra vuoto
                } else {
                    visualizzaItinerari(itinerari); //chiamta a visualizzaItinerari per creare le card delle pagine
                }

            } catch (error) {
                console.error('Errore nel caricamento:', error);
                loadingDiv.style.display = 'none'; //nasconde l'errore
                container.innerHTML = ` 
                    <div style="grid-column: 1/-1; text-align: center; color: white; padding: 40px;">
                        <h3>Errore nel caricamento degli itinerari</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="caricaItinerari()">Riprova</button>
                    </div> 
                `; //messaggio di errore, con pulsante riprova

            }
        }

        // Funzione per visualizzare gli itinerari
        //Prende i riferimenti agli elementi HTML
        function visualizzaItinerari(listaItinerari) {
            const container = document.getElementById('itinerariContainer'); //div dove vengono inserite le card degli itinerari
            const emptyState = document.getElementById('emptyState'); //messaggio che compare se non ci sono itinerari 

            if (listaItinerari.length === 0) { //se l'array è vuoto
                container.innerHTML = ''; //mostra il messaggio "nessun itinerario trovato" (o simile)
                emptyState.style.display = 'block'; 
                return;
            }

            //se ci sono itinerari
            emptyState.style.display = 'none'; //nasconde il messaggio "vuoto"
            container.innerHTML = listaItinerari.map(itinerario => creaCardItinerario(itinerario)).join(''); //usa map per trasformare ogni oggetto in una card HTML
            //Join serve per unire tutte le card in un'unica scritta html, il tutto viene messo dentro container
        }

        // Funzione per creare una card itinerario
        function creaCardItinerario(itinerario) {
            //trasforma le date prese dal DB in un formato leggibile (gg/mm/aaaa)
            const dataCreazione = new Date(itinerario.createdAt || itinerario.createdAt).toLocaleDateString('it-IT');
            const dataAggiornamento = new Date(itinerario.updateAt || itinerario.updatedAt).toLocaleDateString('it-IT');
            
            const travelModeIcons = { //assegno un'icona ad ogni travelMode
                'DRIVING': '🚗',
                'WALKING': '🚶',
                'BICYCLING': '🚴',
                'TRANSIT': '🚌'
            };

            const travelModeNames = { //assegno i valori di default  
                'DRIVING': 'In Auto', 
                'WALKING': 'A Piedi',
                'BICYCLING': 'In Bicicletta',
                'TRANSIT': 'Trasporti Pubblici'
            };

            return `
                <div class="itinerario-card">
                    <div class="card-header">
                        <div class="card-title">${itinerario.titolo}</div>
                        <div class="card-meta">
                            <span>${dataCreazione}</span>
                            <span class="status-badge status-${itinerario.stato}">
                                ${itinerario.stato.toUpperCase()}
                            </span>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        ${itinerario.descrizione ? `<div class="descrizione">${itinerario.descrizione}</div>` : ''}
                        
                        <div class="travel-mode">
                            <span>${travelModeIcons[itinerario.travelMode] || '🚗'}</span>
                            <span>${travelModeNames[itinerario.travelMode] || 'In Auto'}</span>
                        </div>
                        
                        <div class="luoghi-list">
                            <div class="luoghi-title">Luoghi (${itinerario.luoghi.length})</div>
                            <div class="luoghi-container">
                                ${itinerario.luoghi.map(luogo => `
                                    <span class="luogo-tag">${luogo}</span>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="date-info">
                            Ultimo aggiornamento: ${dataAggiornamento}
                        </div>
                        
                        <div class="card-actions">
                            <button class="btn btn-edit" onclick="modificaItinerario('${itinerario._id}')">
                                Modifica
                            </button>
                            <button class="btn btn-danger" onclick="eliminaItinerario('${itinerario._id}', '${itinerario.titolo}')">
                                Elimina
                            </button>
                        </div>
                    </div>
                </div>
            `; //creazione della card
        }

        // Funzione per applicare filtri con ricerca nel database
        async function applicaFiltri() {
            //prende i dati inseriti dall'utente
            const searchTerm = document.getElementById('searchInput').value.toLowerCase(); //toLowerCase per prevenire problemi
            const statusFilter = document.getElementById('statusFilter').value;
            const travelModeFilter = document.getElementById('travelModeFilter').value;

            const loadingDiv = document.getElementById('loadingDiv');
            const container = document.getElementById('itinerariContainer');
            const emptyState = document.getElementById('emptyState');

            try {
                loadingDiv.style.display = 'block'; //mostra il loadingDiv
                container.innerHTML = ''; //svuota il container dove appaiono gli itinerari
                emptyState.style.display = 'none'; //nasconde il messaggio vuoto

                // Costruisci i parametri di ricerca. Prepara l'URL in modo dinamico prendendo i valori di searchTerm, statusFilter e travelModelFilter
                const searchParams = new URLSearchParams();
                
                if (searchTerm) searchParams.append('search', searchTerm);
                if (statusFilter) searchParams.append('stato', statusFilter);
                if (travelModeFilter) searchParams.append('travelMode', travelModeFilter);

                // Chiama API di ricerca nel database. Manda la richiesta al server con per ottenere gli itinerari che corrispondono ai filtri
                const response = await fetch(`/api/itinerari/ricerca?${searchParams.toString()}`);
                
                if (!response.ok) { //capire meglio
                    throw new Error(`Errore HTTP: ${response.status}`);
                }

                const result = await response.json(); //converte la risposta json in oggetto javascript
                console.log('Risultati ricerca dal database:', result);

                const itinerariFiltrati = result.data || result || []; //prende i dati, capire meglio

                loadingDiv.style.display = 'none'; //nasconde il loader

                if (itinerariFiltrati.length === 0) {
                    emptyState.style.display = 'block'; //se non ci sono risultati mostra un messaggio vuoto
                } else {
                    visualizzaItinerari(itinerariFiltrati); //altrimenti mostra gli itinerari trovati
                }

            } catch (error) {
                console.error('Errore nella ricerca:', error);
                loadingDiv.style.display = 'none';
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; color: white; padding: 40px;">
                        <h3>Errore nella ricerca</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="caricaItinerari()">Carica tutti</button>
                    </div>
                `;
            }
        }

        // Debounce per la ricerca (evita troppe chiamate durante la digitazione)
        let searchTimeout;
        function applicaFiltriConDebounce() {
            clearTimeout(searchTimeout); //ogni volta che digito qualcosa, scatta immediatamente applica filtri, così facendo annullo la chiamata (timer già partito)
            searchTimeout = setTimeout(() => { //qui parte un nuovo timer di 500ms, se entro questo timer l'utente scrive, questo viene annullato altrimenti viene
                applicaFiltri();               //chiamata la funzione applicaFiltri() 
            }, 500); // Aspetta 500ms dopo l'ultimo carattere digitato
        }

        // Funzione per modificare un itinerario
        function modificaItinerario(id) {
            // Reindirizza alla pagina CreaItinerario con l'ID nell'URL
            window.location.href = `CreaItinerario.html?id=${id}`;
        }   

        // Funzione per eliminare un itinerario
        async function eliminaItinerario(id, titolo) {
            if (!confirm(`Sei sicuro di voler eliminare l'itinerario "${titolo}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/itinerari/cancella/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`Itinerario "${titolo}" eliminato con successo`);
                    caricaItinerari(); // Ricarica la lista
                } else {
                    alert(`Errore nell'eliminazione: ${result.message || result.error}`);
                }
            } catch (error) {
                console.error('Errore eliminazione:', error);
                alert('Errore di connessione durante l\'eliminazione');
            }
        }
    </script>
</body>
</html>
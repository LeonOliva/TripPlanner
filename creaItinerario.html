<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Itinerari con Google Maps</title>
<style>
    #map{
        height: 400px; 
        width: 100%;
        margin-bottom: 20px;
    }
    
    .controls {
        margin: 20px 0;
    }
    
    .controls input {
        margin: 5px;
        padding: 8px;
        width: 200px;
    }
    
    .controls button {
        margin: 5px;
        padding: 8px 15px;
        background-color: #4285f4;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .controls button:hover {
        background-color: #3367d6;
    }
    
    /* Stili aggiunti per le sezioni mancanti */
    .form-section {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }
    
    .form-info {
        background: #e3f2fd;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
    }
    
    .luoghi-container {
        border: 2px dashed #ddd;
        padding: 15px;
        border-radius: 6px;
    }
    
    .luogo-item {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
    }
    
    .luogo-item input {
        flex: 1;
    }
    
    .btn {
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .btn-danger {
        background-color: #dc3545;
        color: white;
    }
    
    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }
    
    /* Stili per i pulsanti principali */
    .main-actions {
        text-align: center;
        margin: 30px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .main-actions .btn {
        margin: 0 10px;
        padding: 12px 24px;
        font-size: 16px;
        font-weight: bold;
    }
    
    .btn-primary {
        background-color: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background-color: #0056b3;
    }
    
    .btn-success {
        background-color: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background-color: #218838;
    }
</style>
</head>
<body>
    <h1>Crea itinerario</h1>
    
    <div class="form-section">
        <h3>Informazioni Base</h3>
        <div>
            <label for="titolo">Titolo Itinerario</label>
            <input type="text" id="titolo" maxlength="100" placeholder="Es: Weekend a Roma" required>
        </div>
        <div>
            <br><textarea id="descrizione" name="descrizione" maxlength="500" placeholder="Descrivi il tuo itinerario..."  style="width:500px;height:100px;"></textarea> 
        </div>
        <div class="controls">
            <label for="travelMode">Modalit√† di viaggio</label>
            <select id="travelMode" name="travelMode">
                <option value="DRIVING">In Auto</option>
                <option value="WALKING">A Piedi</option>
                <option value="BICYCLING">In Bicicletta</option>
                <option value="TRANSIT">Trasporti Pubblici</option>
            </select>
        </div>
        <div>
            <label for="stato">Stato</label>
            <select id="stato" name="stato">
                <option value="bozza">Bozza</option>
                <option value="completato">Completato</option>
            </select>
        </div>
    </div>
    
    <div class="form-section">
        <h3>Luoghi dell'itinerario</h3>
        <div class="form-info">
             <p>Aggiungi i luoghi che vuoi visitare. Il primo sar√† la partenza, l'ultimo la destinazione finale.</p>
        </div>

        <div class="luoghi-container" id="luoghiContainer">
            <div class="luogo-item">
                <input type="text" class="luogo-input" placeholder="Punto di partenza" data-index="0">
                <button type="button" class="btn btn-danger" onclick="rimuoviLuogo(0)" style="display: none;">Rimuovi</button>
            </div>
        </div>

        <button type="button" class="btn btn-secondary" onclick="aggiungiLuogo()">Aggiungi Luogo</button>
    </div>

    <div class="controls">
        <input style="width:500px" id="search-box" type="text" placeholder="Cerca un luogo">
    </div>
    
    <!--mappa-->
    <div id="map"></div>
    
    <!--pulsanti-->
    <div class="main-actions">
        <button type="button" class="btn btn-primary" onclick="creaItinerario()">Crea Itinerario</button>
        <button type="button" class="btn btn-success" onclick="salvaItinerario()">Salva Itinerario</button>
        <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
    </div>

    <script>
    let map, directionsService, directionsRenderer;
    let marker, autocomplete;
    let luoghiCount = 1;
    let itinerarioIdInModifica = null; // Variabile globale per l'ID

    function initMap(){
        const startPosition = {lat: 41.9028, lng: 12.4964};

        map = new google.maps.Map(document.getElementById("map"), {
            center: startPosition, 
            zoom: 6,
        });
        
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer();
        directionsRenderer.setMap(map);
        
        marker = new google.maps.Marker({
            map: map,
            position: startPosition
        });

        const input = document.getElementById("search-box");
        autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo("bounds", map);
        
        autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (!place.geometry || !place.geometry.location) {
                alert("Nessun dettaglio disponibile per: " + place.name);
                return;
            }
            
            if (place.geometry.viewport) {
                map.fitBounds(place.geometry.viewport);
            } else {
                map.setCenter(place.geometry.location);
                map.setZoom(15);
            }

            marker.setPosition(place.geometry.location);
        });
        
        inizializzaAutocompleteLuoghi();
    }

    // Carica dati se in modalit√† modifica
    window.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);
        const id = params.get("id");

        if (!id) {
            console.log("Modalit√†: Crea nuovo itinerario");
            return;
        }

        console.log("‚úèÔ∏è Modalit√† modifica per ID:", id);
        itinerarioIdInModifica = id;

        try {
            const res = await fetch(`/api/itinerari/visualizza/${id}`);
            if (!res.ok) throw new Error("Errore nel caricamento");
            
            const data = await res.json();
            const itinerario = data.data || data;

            // Popola i campi
            document.getElementById("titolo").value = itinerario.titolo || "";
            document.getElementById("descrizione").value = itinerario.descrizione || "";
            document.getElementById("travelMode").value = itinerario.travelMode || "DRIVING";
            document.getElementById("stato").value = itinerario.stato || "bozza";

            // Carica i luoghi
            const container = document.getElementById("luoghiContainer");
            container.innerHTML = "";
            
            itinerario.luoghi.forEach((luogo, index) => {
                const div = document.createElement("div");
                div.className = "luogo-item";
                const placeholder = index === 0 ? 'Punto di partenza' : 
                                   index === itinerario.luoghi.length - 1 ? 'Destinazione finale' : 
                                   `Tappa ${index}`;
                div.innerHTML = `
                    <input type="text" class="luogo-input" placeholder="${placeholder}" 
                           data-index="${index}" value="${luogo}">
                    <button type="button" class="btn btn-danger" onclick="rimuoviLuogo(${index})" 
                            style="display: ${itinerario.luoghi.length > 1 ? 'block' : 'none'};">Rimuovi</button>
                `;
                container.appendChild(div);
            });

            luoghiCount = itinerario.luoghi.length;
            inizializzaAutocompleteLuoghi();
            aggiornaVisibilitaPulsantiRimozione();

            // Cambia titolo e pulsante
            document.querySelector('h1').textContent = 'Modifica Itinerario';
            const btnSalva = document.querySelector('.btn-success');
            if (btnSalva) {
                btnSalva.textContent = 'üíæ Aggiorna Itinerario';
            }

            // Carica percorso sulla mappa
            if (itinerario.luoghi && itinerario.luoghi.length >= 2) {
                setTimeout(() => creaItinerario(), 1000);
            }

        } catch (error) {
            console.error("Errore caricamento:", error);
            alert("Impossibile caricare l'itinerario per la modifica.");
        }
    });

    function creaItinerario() {
        console.log("üéØ Inizio creazione itinerario...");
        
        const luoghiInputs = document.querySelectorAll('.luogo-input');
        const luoghi = Array.from(luoghiInputs)
            .map(input => input.value.trim())
            .filter(value => value !== '');

        if (luoghi.length === 0) {
            alert("Inserisci almeno un luogo per creare l'itinerario");
            return;
        }

        if (luoghi.length === 1) {
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: luoghi[0] }, (results, status) => {
                if (status === 'OK') {
                    map.setCenter(results[0].geometry.location);
                    map.setZoom(15);
                    marker.setPosition(results[0].geometry.location);
                    alert(`Luogo trovato: ${luoghi[0]}`);
                } else {
                    alert(`Impossibile trovare il luogo: ${luoghi[0]}`);
                }
            });
            return;
        }

        const travelMode = document.getElementById('travelMode').value;
        const waypoints = luoghi.slice(1, -1).map(luogo => ({
            location: luogo,
            stopover: true
        }));

        const request = {
            origin: luoghi[0],
            destination: luoghi[luoghi.length - 1],
            waypoints: waypoints,
            travelMode: google.maps.TravelMode[travelMode]
        };

        directionsService.route(request, (result, status) => {
            if (status === "OK") {
                directionsRenderer.setDirections(result);
                const route = result.routes[0];
                const totalDistance = route.legs.reduce((total, leg) => total + leg.distance.value, 0);
                const totalDuration = route.legs.reduce((total, leg) => total + leg.duration.value, 0);

                alert(`Itinerario creato con successo!
Distanza totale: ${(totalDistance / 1000).toFixed(1)} km
Tempo stimato: ${Math.round(totalDuration / 60)} minuti
Tappe: ${luoghi.length}`);
            } else {
                alert("Errore nella creazione dell'itinerario: " + status);
            }
        });
    }

    async function salvaItinerario() {
        const titolo = document.getElementById('titolo').value.trim();
        const descrizione = document.getElementById('descrizione').value.trim();
        const travelMode = document.getElementById('travelMode').value;
        const stato = document.getElementById('stato').value;

        const luoghiInputs = document.querySelectorAll('.luogo-input');
        const luoghi = Array.from(luoghiInputs)
            .map(input => input.value.trim())
            .filter(value => value !== '');

        if (!titolo) {
            alert('‚ö†Ô∏è Il titolo √® obbligatorio');
            document.getElementById('titolo').focus();
            return;
        }

        if (luoghi.length === 0) {
            alert('‚ö†Ô∏è Inserisci almeno un luogo');
            return;
        }

        const itinerarioData = {
            titolo,
            descrizione,
            luoghi,
            travelMode,
            stato
        };

        try {
            let url, method, successMsg;
            
            if (itinerarioIdInModifica) {
                // MODIFICA
                url = `/api/itinerari/modifica/${itinerarioIdInModifica}`;
                method = "PUT";
                successMsg = "Itinerario aggiornato con successo!";
            } else {
                // CREAZIONE
                url = "/api/itinerari/crea";
                method = "POST";
                successMsg = "Itinerario creato con successo!";
            }

            const response = await fetch(url, {
                method: method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(itinerarioData)
            });

            if (response.ok) {
                const result = await response.json();
                alert(`‚úÖ ${successMsg}\n\nTitolo: ${result.data.titolo}\nLuoghi: ${result.data.luoghi.length}`);
                
                if (confirm('Vuoi visualizzare tutti gli itinerari?')) {
                    window.location.href = "VisualizzaItinerari.html";
                } else {
                    window.location.href = "CreaItinerario.html";
                }
            } else {
                const errorResult = await response.json();
                alert(`‚ùå Errore: ${errorResult.message || errorResult.error}`);
            }
        } catch (error) {
            console.error("Errore:", error);
            alert("‚ùå Errore di connessione al server.");
        }
    }

    function resetForm() {
        if (confirm('Sei sicuro di voler resettare tutto il form?')) {
            document.getElementById('titolo').value = '';
            document.getElementById('descrizione').value = '';
            document.getElementById('travelMode').value = 'DRIVING';
            document.getElementById('stato').value = 'bozza';
            document.getElementById('search-box').value = '';

            const container = document.getElementById('luoghiContainer');
            container.innerHTML = `
                <div class="luogo-item">
                    <input type="text" class="luogo-input" placeholder="Punto di partenza" data-index="0">
                    <button type="button" class="btn btn-danger" onclick="rimuoviLuogo(0)" style="display:none;">Rimuovi</button>
                </div>
            `;
            
            luoghiCount = 1;
            directionsRenderer.setDirections({routes:[]});
            marker.setPosition({lat: 41.9028, lng: 12.4964});
            map.setCenter({lat: 41.9028, lng: 12.4964});
            map.setZoom(6);
            inizializzaAutocompleteLuoghi();
        }
    }

    function aggiungiLuogo() {
        const container = document.getElementById('luoghiContainer');
        const nuovoLuogo = document.createElement('div');
        nuovoLuogo.className = 'luogo-item';
        
        const placeholder = luoghiCount === 1 ? 'Destinazione finale' : `Tappa ${luoghiCount}`;

        nuovoLuogo.innerHTML = `
            <input type="text" class="luogo-input" placeholder="${placeholder}" data-index="${luoghiCount}">
            <button type="button" class="btn btn-danger" onclick="rimuoviLuogo(${luoghiCount})">Rimuovi</button>
        `;
        
        container.appendChild(nuovoLuogo);
        luoghiCount++;
        inizializzaAutocompleteLuoghi();
        aggiornaVisibilitaPulsantiRimozione();
    }

    function rimuoviLuogo(index) {
        const container = document.getElementById('luoghiContainer');
        const luogoItems = container.querySelectorAll('.luogo-item');

        luogoItems.forEach(item => {
            const input = item.querySelector('.luogo-input');
            if (input && input.dataset.index == index) {
                item.remove();
            }
        });
        
        aggiornaVisibilitaPulsantiRimozione();
    }

    function inizializzaAutocompleteLuoghi() {
        const luoghiInputs = document.querySelectorAll('.luogo-input');
        luoghiInputs.forEach(input => {
            if (!input.hasAttribute('data-autocomplete')) {
                const autocomp = new google.maps.places.Autocomplete(input);
                autocomp.bindTo("bounds", map);
                input.setAttribute('data-autocomplete', 'true');
            }
        });
    }

    function aggiornaVisibilitaPulsantiRimozione() {
        const container = document.getElementById('luoghiContainer');
        const luogoItems = container.querySelectorAll('.luogo-item');

        luogoItems.forEach((item) => {
            const button = item.querySelector('.btn-danger');
            if (button) {
                button.style.display = luogoItems.length > 1 ? 'block' : 'none';
            }
        });
    }
</script>

<script>
fetch('/api/key')
 .then(res => res.json())
 .then(data => {
    const googleMapsApiKey = data.key;
    const script = document.createElement('script')
    script.src = `https://maps.googleapis.com/maps/api/js?key=${googleMapsApiKey}&libraries=places&callback=initMap`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
 });
</script>
</body>
</html>
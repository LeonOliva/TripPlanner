<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Itinerari con Google Maps</title>
<style>
    #map{
        height: 400px; 
        width: 100%;
        margin-bottom: 20px;
    }
    
    .controls {
        margin: 20px 0;
    }
    
    .controls input {
        margin: 5px;
        padding: 8px;
        width: 200px;
    }
    
    .controls button {
        margin: 5px;
        padding: 8px 15px;
        background-color: #4285f4;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .controls button:hover {
        background-color: #3367d6;
    }
    
    /* Stili aggiunti per le sezioni mancanti */
    .form-section {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }
    
    .form-info {
        background: #e3f2fd;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
    }
    
    .luoghi-container {
        border: 2px dashed #ddd;
        padding: 15px;
        border-radius: 6px;
    }
    
    .luogo-item {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
    }
    
    .luogo-item input {
        flex: 1;
    }
    
    .btn {
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .btn-danger {
        background-color: #dc3545;
        color: white;
    }
    
    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }
    
    /* Stili per i pulsanti principali */
    .main-actions {
        text-align: center;
        margin: 30px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .main-actions .btn {
        margin: 0 10px;
        padding: 12px 24px;
        font-size: 16px;
        font-weight: bold;
    }
    
    .btn-primary {
        background-color: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background-color: #0056b3;
    }
    
    .btn-success {
        background-color: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background-color: #218838;
    }
</style>
</head>
<body>
    <h1>Crea itinerario</h1>
    
    <div class="form-section">
        <h3>Informazioni Base</h3>
        <div>
            <label for="titolo">Titolo Itinerario</label>
            <input type="text" id="titolo" maxlength="100" placeholder="Es: Weekend a Roma" required>
        </div>
        <div>
            <textarea id="descrizione" name="descrizione" maxlength="500" placeholder="Descrivi il tuo itinerario..."></textarea> 
        </div>
        <div class="controls">
            <label for="travelMode">Modalit√† di viaggio</label>
            <select id="travelMode" name="travelMode">
                <option value="DRIVING">In Auto</option>
                <option value="WALKING">A Piedi</option>
                <option value="BICYCLING">In Bicicletta</option>
                <option value="TRANSIT">Trasporti Pubblici</option>
            </select>
        </div>
        <div>
            <label for="stato">Stato</label>
            <select id="stato" name="stato">
                <option value="bozza">Bozza</option>
                <option value="completato">Completato</option>
            </select>
        </div>
    </div>
    
    <div class="form-section">
        <h3>Luoghi dell'itinerario</h3>
        <div class="form-info">
             <p>Aggiungi i luoghi che vuoi visitare. Il primo sar√† la partenza, l'ultimo la destinazione finale.</p>
        </div>

        <div class="luoghi-container" id="luoghiContainer">
            <div class="luogo-item">
                <input type="text" class="luogo-input" placeholder="Punto di partenza" data-index="0">
                <button type="button" class="btn btn-danger" onclick="rimuoviLuogo(0)" style="display: none;">Rimuovi</button>
            </div>
        </div>

        <button type="button" class="btn btn-secondary" onclick="aggiungiLuogo()">Aggiungi Luogo</button>
    </div>

    <div class="controls">
        <input style="width:500px" id="search-box" type="text" placeholder="Cerca un luogo">
    </div>
    
    <!--mappa-->
    <div id="map"></div>
    
    <!--pulsanti-->
    <div class="main-actions">
        <button type="button" class="btn btn-primary" onclick="creaItinerario()">Crea Itinerario</button>
        <button type="button" class="btn btn-success" onclick="salvaItinerario()">Salva Itinerario</button>
        <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
    </div>

    <script>
        let map, directionsService, directionsRenderer;
        let marker, autocomplete;
        let luoghiCount = 1;

        function initMap(){
            const startPosition = {lat: 41.9028, lng: 12.4964}; // Roma

            map = new google.maps.Map(document.getElementById("map"), {
                center: startPosition, 
                zoom: 6,
            });
            
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);
            
            // Marcatori
            marker = new google.maps.Marker({
                map: map,
                position: startPosition
            });

            // Autocomplete per la search box
            const input = document.getElementById("search-box");
            autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.bindTo("bounds", map);
            
            // Evento: quando l'utente sceglie un luogo
            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();
                if (!place.geometry || !place.geometry.location) {
                    alert("Nessun dettaglio disponibile per: " + place.name);
                    return;
                }
                
                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(15);
                }

                marker.setPosition(place.geometry.location);
            });
            
            inizializzaAutocompleteLuoghi();
        }

        // FUNZIONE CORRETTA: Crea Itinerario
        function creaItinerario() {
            console.log("üéØ Inizio creazione itinerario...");
            
            const luoghiInputs = document.querySelectorAll('.luogo-input');
            const luoghi = Array.from(luoghiInputs)
                .map(input => input.value.trim())
                .filter(value => value !== '');

            console.log("üìç Luoghi trovati:", luoghi);

            if (luoghi.length === 0) {
                alert("Inserisci almeno un luogo per creare l'itinerario");
                return;
            }

            // Se c'√® un solo luogo, centra la mappa su di esso
            if (luoghi.length === 1) {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: luoghi[0] }, (results, status) => {
                    if (status === 'OK') {
                        map.setCenter(results[0].geometry.location);
                        map.setZoom(15);
                        marker.setPosition(results[0].geometry.location);
                        alert(`Luogo trovato: ${luoghi[0]}`);
                    } else {
                        alert(`Impossibile trovare il luogo: ${luoghi[0]}`);
                    }
                });
                return;
            }

            // Se ci sono pi√π luoghi, calcola il percorso
            const travelMode = document.getElementById('travelMode').value;
            console.log("üöó Modalit√† di viaggio:", travelMode);

            // Corretto: waypoints sono i luoghi intermedi (esclusi primo e ultimo)
            const waypoints = luoghi.slice(1, -1).map(luogo => ({
                location: luogo,
                stopover: true  // CORRETTO: era "stopovere"
            }));

            console.log("üõ§Ô∏è Waypoints:", waypoints);

            const request = {
                origin: luoghi[0],
                destination: luoghi[luoghi.length - 1],
                waypoints: waypoints,
                travelMode: google.maps.TravelMode[travelMode]  // CORRETTO: era "travelMode"
            };

            console.log("üìÆ Request Google Maps:", request);

            directionsService.route(request, (result, status) => {
                console.log("üì° Risposta Google Maps:", status);
                
                if (status === "OK") {
                    directionsRenderer.setDirections(result);
                    console.log("‚úÖ Itinerario creato:", result);

                    // CORRETTO: era "result.route[0]" invece di "result.routes[0]"
                    const route = result.routes[0];
                    const totalDistance = route.legs.reduce((total, leg) => total + leg.distance.value, 0);
                    const totalDuration = route.legs.reduce((total, leg) => total + leg.duration.value, 0);

                    alert(`Itinerario creato con successo!
Distanza totale: ${(totalDistance / 1000).toFixed(1)} km
Tempo stimato: ${Math.round(totalDuration / 60)} minuti
Tappe: ${luoghi.length}`);
                } else {
                    console.error("‚ùå Errore Google Maps:", status);
                    alert("Errore nella creazione dell'itinerario: " + status);
                }
            });
        }

        // Funzione per salvare l'itinerario
        async function salvaItinerario() {
            const titolo = document.getElementById('titolo').value.trim();
            const descrizione = document.getElementById('descrizione').value.trim();
            const travelMode = document.getElementById('travelMode').value;
            const stato = document.getElementById('stato').value;

            const luoghiInputs = document.querySelectorAll('.luogo-input');
            const luoghi = Array.from(luoghiInputs)
                .map(input => input.value.trim())
                .filter(value => value !== '');

            // Validazione pi√π robusta
            if (!titolo) {
                alert('Il titolo √® obbligatorio');
                document.getElementById('titolo').focus();
                return;
            }

            if (luoghi.length === 0) {
                alert('Inserisci almeno un luogo per l\'itinerario');
                return;
            }

            const itinerarioData = {
                titolo: titolo,
                descrizione: descrizione,
                luoghi: luoghi,
                travelMode: travelMode,
                stato: stato
            };

            console.log('Dati da inviare al backend:', itinerarioData);
            
            try {
                // Chiamata API al controller
                const response = await fetch("/api/itinerari/crea", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(itinerarioData)
                });

                console.log('Status response:', response.status);

                if (response.ok) {
                    // Successo (status 201)
                    const result = await response.json();
                    console.log('Response data:', result);

                    alert(`Itinerario "${result.data.titolo}" salvato con successo!
ID: ${result.data._id}
Luoghi: ${result.data.luoghi.length}
Modalit√†: ${result.data.travelMode}
Stato: ${result.data.stato}`);
                    
                    // Opzionalmente resetta il form
                    if (confirm('Vuoi creare un nuovo itinerario?')) {
                        resetForm();
                    }
                } else {
                    // Gestione errori HTTP (400, 500, etc.)
                    let errorMessage = `Errore HTTP ${response.status}`;
                    
                    try {
                        const errorResult = await response.json();
                        console.error('Errore dal server:', errorResult);
                        
                        if (errorResult.message) {
                            errorMessage = errorResult.message;
                        }
                        
                        // Mostra errori di validazione se presenti
                        if (errorResult.errors && Array.isArray(errorResult.errors)) {
                            errorMessage += '\n\nDettagli:\n' + errorResult.errors.join('\n');
                        }
                    } catch (jsonError) {
                        console.error('Errore nel parsing JSON della risposta di errore:', jsonError);
                        errorMessage += ': Impossibile leggere dettagli errore';
                    }
                    
                    alert('Errore nel salvataggio:\n' + errorMessage);
                }
            } catch (networkError) {
                // Errori di rete, timeout, problemi di connessione
                console.error('Errore di rete:', networkError);
                alert('Errore di connessione al server.\nControlla la connessione internet e riprova.');
            }
        }

        function resetForm() {
            if (confirm('Sei sicuro di voler resettare tutto il form?')) {
                document.getElementById('titolo').value = '';
                document.getElementById('descrizione').value = '';
                document.getElementById('travelMode').value = 'DRIVING';
                document.getElementById('stato').value = 'bozza';
                document.getElementById('search-box').value = '';

                const container = document.getElementById('luoghiContainer');
                container.innerHTML = `
                    <div class="luogo-item">
                        <input type="text" class="luogo-input" placeholder="Punto di partenza" data-index="0">
                        <button type="button" class="btn btn-danger" onclick="rimuoviLuogo(0)" style="display:none;">Rimuovi</button>
                    </div>
                `;
                
                luoghiCount = 1;

                directionsRenderer.setDirections({routes:[]});
                marker.setPosition({lat: 41.9028, lng: 12.4964});
                map.setCenter({lat: 41.9028, lng: 12.4964});  // CORRETTO: era "at" invece di "lat"
                map.setZoom(6);

                inizializzaAutocompleteLuoghi();
            }
        }
    
        function aggiungiLuogo() {
            const container = document.getElementById('luoghiContainer');
            const nuovoLuogo = document.createElement('div');
            nuovoLuogo.className = 'luogo-item';
            
            const placeholder = luoghiCount === 1 ? 'Destinazione finale' : `Tappa ${luoghiCount}`;

            nuovoLuogo.innerHTML = `
                <input type="text" class="luogo-input" placeholder="${placeholder}" data-index="${luoghiCount}">
                <button type="button" class="btn btn-danger" onclick="rimuoviLuogo(${luoghiCount})">Rimuovi</button>
            `;
            
            container.appendChild(nuovoLuogo);
            luoghiCount++;

            inizializzaAutocompleteLuoghi();
            aggiornaVisibilitaPulsantiRimozione();
        }

        function rimuoviLuogo(index) {
            const container = document.getElementById('luoghiContainer');
            const luogoItems = container.querySelectorAll('.luogo-item');

            luogoItems.forEach(item => {
                const input = item.querySelector('.luogo-input');
                if (input && input.dataset.index == index) {
                    item.remove();
                }
            });
            
            aggiornaVisibilitaPulsantiRimozione();
        }

        function inizializzaAutocompleteLuoghi() {
            const luoghiInputs = document.querySelectorAll('.luogo-input');
            luoghiInputs.forEach(input => {
                if (!input.hasAttribute('data-autocomplete')) {
                    const autocomp = new google.maps.places.Autocomplete(input);
                    autocomp.bindTo("bounds", map);
                    input.setAttribute('data-autocomplete', 'true');
                }
            });
        }

        function aggiornaVisibilitaPulsantiRimozione() {
            const container = document.getElementById('luoghiContainer');
            const luogoItems = container.querySelectorAll('.luogo-item');

            luogoItems.forEach((item) => {
                const button = item.querySelector('.btn-danger');
                if (button) {
                    button.style.display = luogoItems.length > 1 ? 'block' : 'none';
                }
            });
        }
    </script>
    
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=API_KEY&libraries=places&callback=initMap">
    </script>
</body>
</html>
